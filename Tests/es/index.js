import{u as t,r as e,d as i,g as s,a,b as o,c as n,e as r}from"../utilities-9mYNj6lG.js";import{marked as h}from"marked";const l=800,c=40;class d{constructor(e,i){this.spatialGrid=null,this.acceleration={pan:{x:0,y:0},zoom:0},this.animationId=null,this.loadCanvas=async t=>{try{if(/^https?:\/\//.test(t))this.data.canvasBaseDir=t.substring(0,t.lastIndexOf("/")+1);else{const e=t.lastIndexOf("/");this.data.canvasBaseDir=-1!==e?t.substring(0,e+1):"./"}this.data.canvasData=await fetch(t).then(t=>t.json()),this.data.canvasData.nodes.forEach(t=>{if("file"===t.type&&t.file&&!t.file.includes("http")){const e=t.file.split("/");t.file=e[e.length-1]}this.data.nodeMap[t.id]=t}),this.data.nodeBounds=this.calculateNodeBounds(),this.buildSpatialGrid()}catch(t){console.error("Failed to load canvas data:",t)}},this.findNodeAtMousePosition=({x:t,y:e})=>{const{x:i,y:s}=this.C2W(this.C2C({x:t,y:e}));let a=[];if(this.spatialGrid){const t=`${Math.floor(i/l)},${Math.floor(s/l)}`;a=this.spatialGrid[t]||[]}else a=this.data.canvasData.nodes;for(const t of a)if(!(i<t.x||i>t.x+t.width||s<t.y||s>t.y+t.height||"non-interactive"===this.judgeInteract(t)))return t;return null},this.judgeInteract=e=>{switch(e?e.type:"default"){case"text":case"link":return"select";case"file":{const i=e?.file;if(!i)throw t;return i.match(/\.(md|wav|mp3)$/i)?"select":"non-interactive"}default:return"non-interactive"}},this.zoom=(t,e)=>{const i=this.data.scale*t;this.zoomToScale(i,e)},this.zoomToScale=(t,e)=>{const i=Math.max(Math.min(t,20),.05);if(i===this.data.scale)return;const s=this.C2C(e);this.data.offsetX=e.x-s.x*i/this.data.scale,this.data.offsetY=e.y-s.y*i/this.data.scale,this.data.scale=i;for(const t of this.registry.hooks.onZoom)t(i)},this.pan=({x:t,y:e})=>{this.data.offsetX+=t,this.data.offsetY+=e},this.panToCoords=({x:t,y:e})=>{this.data.offsetX=t,this.data.offsetY=e},this.shiftFullscreen=(t="toggle")=>{document.fullscreenElement||"toggle"!==t&&"enter"!==t?document.fullscreenElement&&("toggle"===t||"exit"===t)&&document.exitFullscreen():this.data.container.requestFullscreen();for(const t of this.registry.hooks.onToggleFullscreen)t()},this.resetView=()=>{const t=this.data.nodeBounds;if(!t||!this.data.container)return;const e=t.width+200,i=t.height+200,s=this.data.container.clientWidth,a=this.data.container.clientHeight,o=s/e,n=a/i,r=Math.round(1e3*Math.min(o,n))/1e3,h={scale:r,offsetX:s/2-t.centerX*r,offsetY:a/2-t.centerY*r};this.data.offsetX=h.offsetX,this.data.offsetY=h.offsetY,this.data.scale=h.scale},this.C2C=({x:t,y:e})=>({x:t-this.data.offsetX,y:e-this.data.offsetY}),this.C2W=({x:t,y:e})=>({x:t/this.data.scale,y:e/this.data.scale}),this.middleViewer=()=>({x:this.data.container.clientWidth/2,y:this.data.container.clientHeight/2,width:this.data.container.clientWidth,height:this.data.container.clientHeight}),this.animator=()=>{(0!==this.acceleration.pan.x||0!==this.acceleration.pan.y||0!==this.acceleration.zoom)&&(this.data.offsetX+=this.acceleration.pan.x,this.data.offsetY+=this.acceleration.pan.y,this.data.scale*=this.acceleration.zoom,this.acceleration.pan.x>=c?this.acceleration.pan.x-=c:this.acceleration.pan.x=0,this.acceleration.pan.y>=c?this.acceleration.pan.y-=c:this.acceleration.pan.y=0,this.acceleration.zoom>=c?this.acceleration.zoom-=c:this.acceleration.zoom=1),this.animationId=requestAnimationFrame(this.animator)},this.dispose=()=>{this.animationId&&cancelAnimationFrame(this.animationId),this.animationId=null},i.register({api:{main:{pan:this.pan,zoom:this.zoom,zoomToScale:this.zoomToScale,panToCoords:this.panToCoords,shiftFullscreen:this.shiftFullscreen,resetView:this.resetView},dataManager:{middleViewer:this.middleViewer,findNodeAtMousePosition:this.findNodeAtMousePosition}},hooks:{onLoad:[async t=>await this.loadCanvas(t)],onDispose:[this.dispose]}}),this.data=e,this.registry=i}calculateNodeBounds(){let t=1/0,e=1/0,i=-1/0,s=-1/0;this.data.canvasData.nodes.forEach(a=>{t=Math.min(t,a.x),e=Math.min(e,a.y),i=Math.max(i,a.x+a.width),s=Math.max(s,a.y+a.height)});const a=i-t,o=s-e;return{minX:t,minY:e,maxX:i,maxY:s,width:a,height:o,centerX:t+a/2,centerY:e+o/2}}buildSpatialGrid(){if(!(this.data.canvasData.nodes.length<50)){this.spatialGrid={};for(const t of this.data.canvasData.nodes){const e=Math.floor(t.x/l),i=Math.floor((t.x+t.width)/l),s=Math.floor(t.y/l),a=Math.floor((t.y+t.height)/l);for(let o=e;o<=i;o++)for(let e=s;e<=a;e++){const i=`${o},${e}`;this.spatialGrid[i]||(this.spatialGrid[i]=[]),this.spatialGrid[i].push(t)}}}}}class p extends EventTarget{constructor(e,i={}){super(),this.pointers=new Map,this.pinchZoomState={lastDistance:0,lastMidpoint:{x:0,y:0}},this.onPointerDown=e=>{if(!(this.pointers.size>=2)&&(e.isPrimary&&this.pointers.clear(),this.pointers.set(e.pointerId,{startX:e.clientX,startY:e.clientY,lastX:e.clientX,lastY:e.clientY,interrupted:!1,target:e.target}),2===this.pointers.size)){const i=this.getNthValue(0),s=this.pointers.get(e.pointerId);if(!i||!s)throw t;i.interrupted=!0,s.interrupted=!0,this.pinchZoomState.lastDistance=this.getPointerDistance(),this.pinchZoomState.lastMidpoint=this.S2C(this.getPointerMidpoint())}},this.onPointerMove=e=>{const i=this.pointers.get(e.pointerId);if(i){if(1===this.pointers.size){const t=e.clientX-i.lastX,s=e.clientY-i.lastY;this.dispatchPanEvent({x:t,y:s})}if(this.pointers.set(e.pointerId,{startX:i.startX,startY:i.startY,lastX:e.clientX,lastY:e.clientY,interrupted:i.interrupted,target:i.target}),2===this.pointers.size){const e=this.getPointerDistance(),i=this.getPointerMidpoint();if(!e||!i)throw t;const s=e/this.pinchZoomState.lastDistance;this.pinchZoomState.lastDistance=e;const a=this.S2C(i),o=a.x-this.pinchZoomState.lastMidpoint.x,n=a.y-this.pinchZoomState.lastMidpoint.y;this.pinchZoomState.lastMidpoint=a,this.dispatchPanEvent({x:o,y:n}),this.dispatchZoomEvent(s,a)}}},this.onPointerUp=t=>{const e=this.pointers.get(t.pointerId);if(e&&(this.pointers.delete(t.pointerId),0===this.pointers.size&&!e.interrupted&&Math.abs(e.startX-t.clientX)+Math.abs(e.startY-t.clientY)<5)){const i=this.S2C({x:t.clientX,y:t.clientY}),s=new CustomEvent("trueClick",{detail:{position:i,target:e.target}});this.dispatchEvent(s)}},this.onWheel=t=>{if(!this.lockControlSchema&&!this.proControlSchema&&(t.ctrlKey||t.shiftKey||Math.abs(t.deltaX)>Math.abs(t.deltaY))&&(this.proControlSchema=!0),this.preventDefault&&t.preventDefault(),this.proControlSchema)if(t.ctrlKey){const e=t.deltaY>0?1-this.ctrlZoomFactor:1+this.ctrlZoomFactor,i=this.S2C({x:t.clientX,y:t.clientY});this.dispatchZoomEvent(e,i)}else t.shiftKey&&Math.abs(t.deltaX)<=Math.abs(t.deltaY)?this.dispatchPanEvent({x:-t.deltaY,y:-t.deltaX}):this.dispatchPanEvent({x:-t.deltaX,y:-t.deltaY});else{const e=1-this.zoomFactor*t.deltaY,i=this.S2C({x:t.clientX,y:t.clientY});this.dispatchZoomEvent(e,i)}},this.preventDefaultFunction=t=>t.preventDefault,this.stop=()=>{this.monitoringElement.removeEventListener("pointerdown",this.onPointerDown),window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this.monitoringElement.removeEventListener("wheel",this.onWheel),this.preventDefault&&(this.monitoringElement.style.touchAction="",this.monitoringElement.removeEventListener("gesturestart",this.preventDefaultFunction),this.monitoringElement.removeEventListener("gesturechange",this.preventDefaultFunction))},this.start=()=>{this.monitoringElement.addEventListener("pointerdown",this.onPointerDown),window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp),this.monitoringElement.addEventListener("wheel",this.onWheel,this.preventDefault?{passive:!1}:{}),this.preventDefault&&(this.monitoringElement.style.touchAction="none",this.monitoringElement.addEventListener("gesturestart",this.preventDefaultFunction,{passive:!1}),this.monitoringElement.addEventListener("gesturechange",this.preventDefaultFunction,{passive:!1}))},this.dispose=()=>this.stop(),this.monitoringElement=e,this.preventDefault=i.preventDefault||!1,this.proControlSchema=i.proControlSchema||!1,this.zoomFactor=i.zoomFactor||.002,this.ctrlZoomFactor=i.zoomFactor?50*i.zoomFactor:.1,this.lockControlSchema=i.lockControlSchema||!1}getNthValue(e){if(e<0||e>=this.pointers.size)throw t;let i=0;for(const t of this.pointers.values()){if(i===e)return t;i++}}getPointerDistance(){const e=this.getNthValue(0),i=this.getNthValue(1);if(!e||!i)throw t;const s=e.lastX-i.lastX,a=e.lastY-i.lastY;return Math.sqrt(s*s+a*a)}getPointerMidpoint(){const e=this.getNthValue(0),i=this.getNthValue(1);if(!e||!i)throw t;return{x:(e.lastX+i.lastX)/2,y:(e.lastY+i.lastY)/2}}S2C({x:t,y:e}){const i=this.monitoringElement.getBoundingClientRect();return{x:t-i.left,y:e-i.top}}dispatchPanEvent(t){const i={x:e(t.x,1),y:e(t.y,1)},s=new CustomEvent("pan",{detail:i});this.dispatchEvent(s)}dispatchZoomEvent(t,i){const s=e(t,4),a=new CustomEvent("zoom",{detail:{factor:s,origin:i}});this.dispatchEvent(a)}}class m{constructor(t,e){this.stop=()=>this.interactor.stop(),this.start=()=>this.interactor.start(),this.onLoad=()=>{this.interactor.addEventListener("pan",this.onPan),this.interactor.addEventListener("zoom",this.onZoom),this.interactor.addEventListener("trueClick",this.onClick),this.start()},this.onPan=t=>{t instanceof CustomEvent&&this.registry.api.main.pan(t.detail)},this.onZoom=t=>{t instanceof CustomEvent&&this.registry.api.main.zoom(t.detail.factor,t.detail.origin)},this.onClick=t=>{if(t instanceof CustomEvent){if(function(t){return t.closest&&(t.closest(".controls")||t.closest("button")||t.closest("input"))}(t.detail.target))return;const e=this.registry.api.dataManager.findNodeAtMousePosition(t.detail.position);for(const t of this.registry.hooks.onClick)t(e?.id||null)}},this.dispose=()=>{this.interactor.removeEventListener("pan",this.onPan),this.interactor.removeEventListener("zoom",this.onZoom),this.interactor.removeEventListener("trueClick",this.onClick),this.interactor.dispose()},e.register({hooks:{onLoad:[this.onLoad],onDispose:[this.dispose],onInteractionStart:[this.stop],onInteractionEnd:[this.start]},options:{interactor:{preventDefault:!0,proControlSchema:!1,zoomFactor:.002,lockControlSchema:!1}},api:{interactionHandler:{stop:this.stop,start:this.start}}}),this.interactor=new p(t.container,e.options.interactor),this.registry=e}}class f{constructor(e,s){this.overlays={},this.selectedId=null,this.eventListeners={},this.onLoad=()=>{const e={text:e=>{if(!e.text)throw t;this.updateOrCreateOverlay(e,e.text,"text")},file:e=>{if(!e.file)throw t;e.file.match(/\.md$/i)?this.loadMarkdownForNode(e):e.file.match(/\.(png|jpg|jpeg|gif|svg|webp)$/i)?this.updateOrCreateOverlay(e,this.data.canvasBaseDir+e.file,"image"):e.file.match(/\.(mp3|wav)$/i)&&this.updateOrCreateOverlay(e,this.data.canvasBaseDir+e.file,"audio")},link:e=>{if(!e.url)throw t;this.updateOrCreateOverlay(e,e.url,"link")},group:()=>{}};Object.values(this.data.nodeMap).forEach(t=>e[t.type](t))},this.select=t=>{const e=this.selectedId?this.overlays[this.selectedId]:null,i=t?this.overlays[t]:null;e&&e.classList.remove("active"),i?(i.classList.add("active"),this.startInteract()):this.endInteract(),this.selectedId=t},this.loadMarkdownForNode=async e=>{if(!e.mdContent){e.mdContent="Loading...",this.updateOrCreateOverlay(e,e.mdContent,"markdown");try{if(!e.file)throw t;const i=await(await fetch(this.data.canvasBaseDir+e.file)).text(),s=i.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);if(s){const t=s[1].split("\n").reduce((t,e)=>{const[i,s]=e.split(":").map(t=>t.trim());return t[i]=s,t},{});e.mdContent=await h.parse(s[2].trim()),e.mdFrontmatter=t}else e.mdContent=await h.parse(i)}catch(t){console.error("Failed to load markdown:",t),e.mdContent="Failed to load content."}}this.updateOrCreateOverlay(e,e.mdContent,"markdown")},this.updateOverlays=()=>this.overlaysLayer.style.transform=`translate(${this.data.offsetX}px, ${this.data.offsetY}px) scale(${this.data.scale})`,this.startInteract=()=>{for(const t of this.registry.hooks.onInteractionStart)t()},this.endInteract=()=>{for(const t of this.registry.hooks.onInteractionEnd)t()},this.dispose=()=>{for(;this.overlaysLayer.firstElementChild;){const t=this.overlaysLayer.firstElementChild;if(this.eventListeners[t.id]){const e=this.eventListeners[t.id][0],s=this.eventListeners[t.id][1];if(!e||!s)throw i;t.removeEventListener("pointerenter",e),t.removeEventListener("pointerleave",s),t.removeEventListener("touchstart",e),t.removeEventListener("touchend",s),this.eventListeners[t.id][0]=null,this.eventListeners[t.id][1]=null}t.remove()}this.overlaysLayer.remove(),this._overlaysLayer=null},s.register({hooks:{onLoad:[this.onLoad],onDispose:[this.dispose],onRender:[this.updateOverlays],onClick:[t=>this.select(t)]}}),this._overlaysLayer=document.createElement("div"),this._overlaysLayer.className="overlays",e.container.appendChild(this.overlaysLayer),this.data=e,this.registry=s}get overlaysLayer(){if(!this._overlaysLayer)throw i;return this._overlaysLayer}async updateOrCreateOverlay(e,i,s){let a=this.overlays[e.id];if(a||(a=await this.constructOverlay(e,i,s),this.overlaysLayer.appendChild(a),this.overlays[e.id]=a,a.style.left=e.x+"px",a.style.top=e.y+"px",a.style.width=e.width+"px",a.style.height=e.height+"px"),"none"===a.style.display&&(a.style.display="flex"),"markdown"===s){const i=a.getElementsByClassName("parsed-content-wrapper")[0];if(!e.mdContent)throw t;i.innerHTML!==e.mdContent&&(i.innerHTML=e.mdContent),!a.classList.contains("rtl")&&"rtl"===e.mdFrontmatter?.direction&&a.classList.add("rtl")}}async constructOverlay(t,e,i){const a=s(t.color),o=document.createElement("div");switch(o.classList.add("overlay-container"),o.id=t.id,o.style.backgroundColor=a.background,o.style.setProperty("--active-color",a.active),i){case"text":case"markdown":{o.classList.add("markdown-content");const t=document.createElement("div");t.innerHTML=await h.parse(e||""),t.classList.add("parsed-content-wrapper"),o.appendChild(t);break}case"link":{const t=document.createElement("iframe");t.src=e,t.sandbox="allow-scripts allow-same-origin",t.className="link-iframe",t.loading="lazy",o.appendChild(t);break}case"audio":{const t=document.createElement("audio");t.className="audio",t.src=e,t.controls=!0,o.appendChild(t);break}case"image":{const t=document.createElement("img");t.src=e,t.loading="lazy",o.appendChild(t)}}switch(i){case"link":case"audio":{const t=document.createElement("div");t.className="click-layer",o.appendChild(t)}}const n=document.createElement("div");n.className="overlay-border",n.style.borderColor=a.border,o.appendChild(n);const r=()=>{t.id===this.selectedId&&this.startInteract()},l=()=>{t.id===this.selectedId&&this.endInteract()};return o.addEventListener("pointerenter",r),o.addEventListener("pointerleave",l),o.addEventListener("touchstart",r),o.addEventListener("touchend",l),this.eventListeners[t.id]=[r,l],o}}const u="#fff";class x{constructor(e,i){this.optimizeDPR=()=>a(this.canvas,this.data.container.offsetWidth,this.data.container.offsetHeight),this.redraw=()=>{this.zoomInOptimize.timeout&&(clearTimeout(this.zoomInOptimize.timeout),this.zoomInOptimize.timeout=null);const t=Date.now(),e=this.getCurrentViewport(this.data.offsetX,this.data.offsetY,this.data.scale);if(this.isViewportInside(e,this.zoomInOptimize.lastDrawnViewport)&&this.data.scale!==this.zoomInOptimize.lastDrawnScale&&t-this.zoomInOptimize.lastCallTime<500)return this.zoomInOptimize.timeout=setTimeout(()=>{this.trueRedraw(this.data.offsetX,this.data.offsetY,this.data.scale,e),this.zoomInOptimize.lastCallTime=t,this.zoomInOptimize.timeout=null},60),void this.fakeRedraw(e,this.data.scale);this.zoomInOptimize.lastCallTime=t,this.trueRedraw(this.data.offsetX,this.data.offsetY,this.data.scale,e)},this.isViewportInside=(t,e)=>t.left>e.left&&t.top>e.top&&t.right<e.right&&t.bottom<e.bottom,this.getCurrentViewport=(t,e,i)=>{const s=-t/i,a=-e/i;return{left:s,top:a,right:s+this.data.container.clientWidth/i,bottom:a+this.data.container.clientHeight/i}},this.drawLabelBar=(t,e,i,s,a)=>{const o=30*a,n=6*a,r=8*a,h=16*a,l=6*a;this.ctx.save(),this.ctx.translate(t,e),this.ctx.scale(1/a,1/a),this.ctx.font=`${h}px 'Inter', sans-serif`;const c=this.ctx.measureText(i).width+2*l;this.ctx.translate(0,-o-r),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.moveTo(n,0),this.ctx.lineTo(c-n,0),this.ctx.quadraticCurveTo(c,0,c,n),this.ctx.lineTo(c,o-n),this.ctx.quadraticCurveTo(c,o,c-n,o),this.ctx.lineTo(n,o),this.ctx.quadraticCurveTo(0,o,0,o-n),this.ctx.lineTo(0,n),this.ctx.quadraticCurveTo(0,0,n,0),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle=u,this.ctx.fillText(i,l,.65*o),this.ctx.restore()},this.drawNodeBackground=t=>{const e=s(t.color);this.ctx.globalAlpha=1,this.ctx.fillStyle=e.background,o(this.ctx,t.x+1,t.y+1,t.width-2,t.height-2,12),this.ctx.fill(),this.ctx.strokeStyle=e.border,this.ctx.lineWidth=2,o(this.ctx,t.x,t.y,t.width,t.height,12),this.ctx.stroke()},this.drawGroup=(t,e)=>{this.drawNodeBackground(t),t.label&&this.drawLabelBar(t.x,t.y,t.label,s(t.color).border,e)},this.drawFileNode=e=>{if(!e.file)throw t;this.ctx.fillStyle=u,this.ctx.font="16px sans-serif",this.ctx.fillText(e.file,e.x+5,e.y-10)},this.drawEdge=e=>{const{fromNode:i,toNode:s}=this.getEdgeNodes(e);if(!i||!s)throw t;const[a,r]=n(i,e.fromSide),[h,l]=n(s,e.toSide);let[c,d,p,m]=[0,0,0,0];if(e.controlPoints?[c,d,p,m]=e.controlPoints:([c,d,p,m]=this.getControlPoints(a,r,h,l,e.fromSide,e.toSide),e.controlPoints=[c,d,p,m]),this.drawCurvedPath(a,r,h,l,c,d,p,m),this.drawArrowhead(h,l,p,m),e.label){const t=Math.pow(.5,3)*a+3*Math.pow(.5,2)*.5*c+.375*p+Math.pow(.5,3)*h,i=Math.pow(.5,3)*r+3*Math.pow(.5,2)*.5*d+.375*m+Math.pow(.5,3)*l;this.ctx.font="18px sans-serif";const s=this.ctx.measureText(e.label).width+16,n=20;this.ctx.fillStyle="#222",this.ctx.beginPath(),o(this.ctx,t-s/2,i-n/2-2,s,n,4),this.ctx.fill(),this.ctx.fillStyle="#ccc",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(e.label,t,i-2),this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}},this.getEdgeNodes=t=>({fromNode:this.data.nodeMap[t.fromNode],toNode:this.data.nodeMap[t.toNode]}),this.getControlPoints=(t,e,i,s,a,o)=>{const n=i-t,r=s-e,h=Math.min(Math.abs(n),Math.abs(r))+.3*Math.max(Math.abs(n),Math.abs(r)),l=(c=.5*h,Math.max(60,Math.min(300,c)));var c;let d=t,p=e,m=i,f=s;switch(a){case"top":p=e-l;break;case"bottom":p=e+l;break;case"left":d=t-l;break;case"right":d=t+l}switch(o){case"top":f=s-l;break;case"bottom":f=s+l;break;case"left":m=i-l;break;case"right":m=i+l}return[d,p,m,f]},this.drawCurvedPath=(t,e,i,s,a,o,n,r)=>{this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.bezierCurveTo(a,o,n,r,i,s),this.ctx.strokeStyle="#ccc",this.ctx.lineWidth=2,this.ctx.stroke()},this.drawArrowhead=(t,e,i,s)=>{const a=t-i,o=e-s,n=Math.sqrt(a*a+o*o);if(0===n)return;const r=a/n,h=o/n,l=t-12*r-7*h,c=e-12*h+7*r,d=t-12*r+7*h,p=e-12*h-7*r;this.ctx.beginPath(),this.ctx.fillStyle="#ccc",this.ctx.moveTo(t,e),this.ctx.lineTo(l,c),this.ctx.lineTo(d,p),this.ctx.closePath(),this.ctx.fill()},this.dispose=()=>{this.zoomInOptimize.timeout&&(clearTimeout(this.zoomInOptimize.timeout),this.zoomInOptimize.timeout=null),this.canvas.remove(),this._canvas=null},i.register({hooks:{onDispose:[this.dispose],onRender:[this.redraw],onResize:[this.optimizeDPR]}}),this._canvas=document.createElement("canvas"),this._canvas.className="main-canvas",e.container.appendChild(this._canvas),this.ctx=this._canvas.getContext("2d"),this.zoomInOptimize={lastDrawnScale:0,lastDrawnViewport:{left:0,right:0,top:0,bottom:0},timeout:null,lastCallTime:0},this.data=e}get canvas(){if(null===this._canvas)throw i;return this._canvas}trueRedraw(t,e,i,s){this.zoomInOptimize.lastDrawnViewport=s,this.zoomInOptimize.lastDrawnScale=i,this.canvas.style.transform="",this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.translate(t,e),this.ctx.scale(i,i),this.data.canvasData.nodes.forEach(t=>{switch(t.type){case"group":this.drawGroup(t,i);break;case"file":this.drawFileNode(t)}}),this.data.canvasData.edges.forEach(t=>this.drawEdge(t)),this.ctx.restore()}fakeRedraw(t,e){const i=e/this.zoomInOptimize.lastDrawnScale,s=(this.zoomInOptimize.lastDrawnViewport.left-t.left)*e,a=(this.zoomInOptimize.lastDrawnViewport.top-t.top)*e;this.canvas.style.transform=`translate(${s}px, ${a}px) scale(${i})`}}class g{constructor(t,e){for(this.animationId=null,this.resizeAnimationId=null,this.perFrame={lastScale:1,lastOffsets:{x:0,y:0}},this.lastResizeCenter={x:null,y:null},this.data={offsetX:0,offsetY:0,scale:1,canvasData:{nodes:[],edges:[],metadata:{version:"",frontmatter:{}}},nodeMap:{},canvasBaseDir:"",nodeBounds:{minX:0,minY:0,maxX:0,maxY:0,width:0,height:0,centerX:0,centerY:0},container:document.createElement("div")},this.registry={options:{},extensions:[d,x,m,f],hooks:{},api:{},register:t=>{if(t.extensions&&t.extensions.forEach(t=>this.registry.extensions.push(t)),t.hooks)for(const e in t.hooks)this.registry.hooks[e]||(this.registry.hooks[e]=[]),t.hooks[e].forEach(t=>this.registry.hooks[e].push(t));t.api&&r(this.registry.api,t.api),t.options&&r(this.registry.options,t.options,!0)}},this.draw=()=>{(this.perFrame.lastScale!==this.data.scale||this.perFrame.lastOffsets.x!==this.data.offsetX||this.perFrame.lastOffsets.y!==this.data.offsetY)&&this.refresh(),this.animationId=requestAnimationFrame(this.draw)},this.refresh=()=>{this.perFrame.lastScale=this.data.scale,this.perFrame.lastOffsets={x:this.data.offsetX,y:this.data.offsetY};for(const t of this.registry.hooks.onRender)t()},this.onResize=()=>{this.resizeAnimationId=requestAnimationFrame(()=>{const t=this.registry.api.dataManager.middleViewer();this.lastResizeCenter.x&&this.lastResizeCenter.y&&(this.data.offsetX+=t.x-this.lastResizeCenter.x,this.data.offsetY+=t.y-this.lastResizeCenter.y),this.lastResizeCenter.x=t.x,this.lastResizeCenter.y=t.y;for(const e of this.registry.hooks.onResize)e(t.width,t.height);this.refresh()})},e&&this.registry.register(e),this.registry.register({options:{main:{noShadow:!1}},api:{main:{loadCanvas:this.loadCanvas,refresh:this.refresh}}});t.firstElementChild;)t.firstElementChild.remove();t.innerHTML="";const i=document.createElement("style");let s;i.innerHTML=".full,.click-layer,.link-iframe,.audio,.prevention-container{top:0;left:0;width:100%;height:100%;position:absolute}.flex-center,.overlay-container.markdown-content,.prevention-container{display:flex;justify-content:center;align-items:center}.container{--contentTransition: color .2s, opacity .2s, text-shadow .2s, fill .2s;--containerTransition: background .2s, opacity .2s, box-shadow .2s, border .2s, filter .2s, backdrop-filter .2s;color:#fff;fill:#fff;stroke:#fff;position:relative;width:100%;height:100%;overflow:hidden;background-color:#141414}.container.numb,.container.numb *{pointer-events:none!important}.prevention-container{overflow:visible;transition:background .2s,opacity .2s,box-shadow .2s,border .2s,filter .2s,backdrop-filter .2s}.prevention-container.hidden{pointer-events:none}.prevention-container .prevention-banner{background:#0006;border-radius:12px;padding:12px;margin:12px;-webkit-backdrop-filter:blur(8px) saturate(1.5);backdrop-filter:blur(8px) saturate(1.5);border:2px solid rgba(140,140,140,.75);color:#fff;font-size:calc(14px + .3vw);line-height:calc(17px + .3vw);text-align:center}.debug-panel{position:absolute;bottom:12px;left:12px;background:#0006;border-radius:12px;padding:12px;-webkit-backdrop-filter:blur(8px) saturate(1.5);backdrop-filter:blur(8px) saturate(1.5);border:2px solid rgba(140,140,140,.75);color:#fff;font-size:calc(14px + .3vw);line-height:calc(17px + .3vw);pointer-events:none}.main-canvas{width:100%;height:100%;transform-origin:top left}button{cursor:pointer;font-size:18px;height:32px;border:none;transition:var(--containerTransition);text-align:center;background-color:#444;width:32px;padding:5px 0}button svg{width:100%;height:100%}.overlays{position:absolute;top:0;left:0;width:100%;height:100%;transform-origin:top left;will-change:transform}.parsed-content-wrapper{font-family:sans-serif;box-sizing:border-box;max-width:100%;max-height:100%;padding:10px 6px;pointer-events:none;overflow:hidden;scrollbar-gutter:stable both-edges;display:flex;flex-direction:column;gap:12px}@supports not (scrollbar-gutter: stable both-edges){.parsed-content-wrapper{padding:10px}}.minimap-container{position:absolute;bottom:10px;right:10px;display:flex;pointer-events:none;transition:transform .2s}.minimap-container.collapsed{transform:translate(calc(100% - 32px))}@media (max-width: 768px){.minimap-container{transform:translateY(60px) translate(80px)}.minimap-container.collapsed{transform:translateY(60px) translate(calc(100% - 32px))}}.toggle-minimap{margin:auto 10px 0 0;pointer-events:auto}.collapsed .toggle-minimap{transform:rotate(180deg)}@media (max-width: 768px){.toggle-minimap{transform:translateY(-60px)}.collapsed .toggle-minimap{transform:translateY(-60px) rotate(180deg)}}.minimap{position:relative;width:200px;height:150px;overflow:hidden;border-radius:12px;background:#202020;-webkit-backdrop-filter:blur(8px) saturate(1.5);backdrop-filter:blur(8px) saturate(1.5);border:2px solid rgba(140,140,140,.75);transform-origin:0 0}@media (max-width: 768px){.minimap{transform:scale(.6)}}.minimap .minimap-canvas{width:100%;height:100%}.minimap .viewport-rectangle{position:absolute;top:0;left:0;pointer-events:none;border:2px solid #fff;border-radius:6px;box-sizing:border-box;background:transparent}.collapse-button{border-radius:8px;transition:transform .2s}.collapse-button:hover{background:#444c}.controls{position:absolute;top:10px;right:10px;display:flex;align-items:center;transition:transform .2s;border-radius:8px;gap:10px}.controls.collapsed{transform:translate(calc(100% - 32px))}.controls.collapsed .collapse-button{transform:rotate(180deg)}.controls .controls-content{display:flex;gap:1px;align-items:center;border-radius:8px;overflow:hidden;background:#333c}.controls button:hover{background:#555}.zoom-slider{width:100px;margin:0 10px}.overlay-container{position:absolute;box-sizing:border-box;border-radius:12px;overflow:hidden;-webkit-user-select:none;user-select:none;contain:strict;content-visibility:auto;transition:var(--containerTransition)}.overlay-container:hover{box-shadow:0 2px 12px #00000080}.overlay-container .overlay-border{box-sizing:border-box;pointer-events:none;position:absolute;top:0;left:0;width:100%;height:100%;border-width:2px;border-style:solid;border-radius:12px;transition:var(--containerTransition)}.overlay-container img{width:100%;height:100%;object-fit:cover;pointer-events:none}.overlay-container.active .overlay-border{border:6px solid var(--active-color)}.overlay-container.markdown-content{position:absolute;padding:0 7px}.overlay-container.markdown-content.active .parsed-content-wrapper{overflow:auto;-webkit-user-select:text;user-select:text;pointer-events:auto}.overlay-container.markdown-content.rtl{direction:rtl;text-align:right}.link-iframe,.audio{border:none;background:transparent}.click-layer{background:transparent;pointer-events:auto}.active .click-layer{pointer-events:none}.katex-html{display:none}::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background-color:transparent}::-webkit-scrollbar-thumb{border-radius:2px;background:#ffffff40}::-webkit-scrollbar-thumb:hover{background:#1e1e1ebf}p{font-size:16px;line-height:21px}.parsed-content-wrapper img{width:100%;border-radius:8px}h1{font-size:25px}h2{font-size:23px}h3{font-size:22px}h4{font-size:20px}h5{font-size:19px}h6{font-size:17px}p,h1,h2,h3,h4,h5,h6,ol,ul{margin:0}h1,h2{font-weight:800}h3,h4{font-weight:700}h5,h6{font-weight:600}code{background:#ffffff1a;padding:2px 4px;border-radius:8px}pre code{display:block;box-sizing:border-box;width:100%}pre:has(code),table{margin:6px 0}strong{color:#fe8e7c}em{color:#5affb2}a{text-decoration:none;color:#6dadd0;font-weight:800;font-style:italic;cursor:pointer;transition:var(--contentTransition)}a:hover{color:#86d3fd}hr{height:1px;width:100%;background-color:#fff3;border:none}li{margin:5px 0}ul{padding-left:16px}ol{padding-left:15px;padding-right:7.5px}table{border-collapse:collapse;border-radius:8px;overflow:hidden;width:100%}table th,table td{border:1px solid rgba(255,255,255,.2);padding:6px 10px;background:#ffffff0f;text-align:left}table th{background:#ffffff1f;font-weight:700}",s=this.registry.options.main.noShadow?t:t.attachShadow({mode:"open"}),s.appendChild(i),this.data.container.classList.add("container"),s.appendChild(this.data.container),this.resizeObserver=new ResizeObserver(this.onResize);for(const t of this.registry.extensions)new t(this.data,this.registry)}async loadCanvas(t){for(const e of this.registry.hooks.onLoad)await e(t);this.registry.api.main.resetView(),this.resizeObserver.observe(this.data.container),this.animationId=requestAnimationFrame(this.draw)}dispose(){this.animationId&&cancelAnimationFrame(this.animationId),this.resizeAnimationId&&cancelAnimationFrame(this.resizeAnimationId),this.resizeObserver.disconnect();for(const t of this.registry.hooks.onDispose)t();this.data.container.remove()}}export{g as default};
